services:

  migrator:
    build:
      context: ./
      dockerfile: DockerfileMigrator 
    environment:
      DB_CONNECTION_STRING: "Server=${DB_HOST};Database=${DB_NAME};User Id=${DB_USER};Password=${DB_PASSWORD};Encrypt=True;TrustServerCertificate=True"
    networks:
      - container_network

  api:
    image: keuzewijzer-api:${ENV_KEY}
    build:
      context: ./
      dockerfile: DockerfileApi
    ports:
      - "${API_PORT}:8080"
    volumes:
      - ./KeuzeWijzerCore.dll:/app/KeuzeWijzerCore.dll:r
    environment:
      ASPNETCORE_HTTP_PORTS: "8080"
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      DB_CONNECTION_STRING: "Server=${DB_HOST};Database=${DB_NAME};User Id=${DB_USER};Password=${DB_PASSWORD};Encrypt=True;TrustServerCertificate=True"
    networks:
      - container_network
    depends_on:
      - migrator

  mvc:
    image: keuzewijzer-mvc:${ENV_KEY}
    build:
      context: ./
      dockerfile: DockerfileMvc
    ports:
      - "${MVC_PORT}:8082"
    environment:
      # Use the internal container port!
      ApiUri: "http://${ENV_KEY}-server-api-1:8080"
      ASPNETCORE_HTTP_PORTS: "8082"
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
    networks:
      - container_network
    depends_on:
      - migrator
      

networks:
  container_network:
    name: ${ENV_KEY}_network
    external: true